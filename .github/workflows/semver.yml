name: Tests and Release
on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  tests:
    if: |
      github.event_name == 'push' &&
      !contains(github.event.head_commit.message, '[skip ci]')
    name: Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'

      - name: Configure .env file
        run: |
          cp .env.testing.example .env.testing
          mkdir -p var/logs
          touch var/logs/app.log

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run tests
        run: composer run-script test

  # run this job only if the tests pass

  release:
    needs: tests
    if: ${{ needs.tests.result == 'success' }}
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # to be able to create releases
      issues: write # to be able to comment on released issues
      pull-requests: write # to be able to comment on released pull requests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Fix Git permissions and setup
        run: |
          echo "=== Verificando permisos iniciales ==="
          ls -la
          whoami
          id
          
          echo "=== Corrigiendo permisos del workspace ==="
          # Configurar propietario correcto de todo el directorio
          sudo chown -R $(whoami):$(whoami) .
          
          # Permisos especÃ­ficos para .git
          chmod -R u+rwX .git
          
          # Permisos para archivos del proyecto
          chmod 644 composer.json
          [ -f .env.example ] && chmod 644 .env.example
          
          echo "=== Configurando Git ==="
          # Configurar directorio seguro
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          git config --local push.default simple
          
          echo "=== Verificando configuraciÃ³n ==="
          git config --list | grep user
          git status
          
          echo "=== Permisos despuÃ©s de correcciÃ³n ==="
          ls -la .git | head -3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          github-token: ${{ secrets.GIT_TOKEN }}

      - name: Configure .env file
        run: |
          cp .env.example .env
          mkdir -p var/logs
          touch var/logs/app.log

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Get the next version on dry-run    # or get the current version if it's nothing to release
        id: version
        uses: huggingface/semver-release-action@latest
        with:
          dryRun: true
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}

      - name: Check if there is a new version to release
        id: check_release
        run: |
          CURRENT_VERSION=$(jq -r '.version' composer.json)
          NEXT_VERSION="${{ steps.version.outputs.version }}"
          
          echo "VersiÃ³n actual: $CURRENT_VERSION"
          echo "PrÃ³xima versiÃ³n: $NEXT_VERSION"

          if [ -z "$NEXT_VERSION" ] || [ "$NEXT_VERSION" == "null" ]; then
            echo "No hay nueva versiÃ³n para liberar"
            echo "released=false" >> $GITHUB_OUTPUT
          elif [ "$CURRENT_VERSION" == "$NEXT_VERSION" ]; then
            echo "La versiÃ³n no ha cambiado"
            echo "released=false" >> $GITHUB_OUTPUT
          else
            echo "Nueva versiÃ³n detectada: $CURRENT_VERSION â†’ $NEXT_VERSION"
            echo "released=true" >> $GITHUB_OUTPUT
            # Exportar versiones para otros pasos
            echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
            echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_ENV
          fi

      - name: Update composer.json with next version
        if: ${{ steps.check_release.outputs.released == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: |
          NEXT_VERSION=${{ steps.version.outputs.version }}
          
          echo "Actualizando composer.json a versiÃ³n $NEXT_VERSION"
          
          # Crear backup del archivo original
          cp composer.json composer.json.backup
          
          # Actualizar versiÃ³n usando jq con validaciÃ³n
          jq --arg new_version "$NEXT_VERSION" '.version = $new_version' composer.json > composer.json.tmp
          
          # Verificar que el archivo temporal se creÃ³ correctamente
          if [ ! -f composer.json.tmp ]; then
            echo "Error: No se pudo crear composer.json.tmp"
            exit 1
          fi
          
          # Verificar que el contenido es JSON vÃ¡lido
          if ! jq empty composer.json.tmp 2>/dev/null; then
            echo "Error: composer.json.tmp no es un JSON vÃ¡lido"
            cat composer.json.tmp
            exit 1
          fi
          
          # Reemplazar archivo original
          mv composer.json.tmp composer.json
          
          # Verificar el cambio
          echo "=== Verificando cambio en composer.json ==="
          git diff composer.json
          
          # Verificar estado de Git antes del commit
          echo "=== Estado de Git antes del commit ==="
          git status
          
          # AÃ±adir archivo al staging area
          git add composer.json
          
          # Verificar que hay cambios para commitear
          if git diff --cached --exit-code composer.json > /dev/null 2>&1; then
            echo "No hay cambios en composer.json para commitear"
            exit 0
          fi
          
          # Realizar commit con informaciÃ³n detallada
          git commit -m "chore: Bump version to $NEXT_VERSION [skip ci]

          - Previous version: $CURRENT_VERSION
          - New version: $NEXT_VERSION
          - Auto-generated by semver workflow
          - Commit SHA: ${{ github.sha }}"
          
          # Push con verificaciÃ³n
          echo "=== Realizando push ==="
          git push origin HEAD:main

      - name: Format Code
        if: ${{ steps.check_release.outputs.released == 'true' }}
        run: composer run-script format

      - name: Clean Dev Dependencies for Release
        if: ${{ steps.check_release.outputs.released == 'true' }}
        run: |
          echo "=== Limpiando dependencias de desarrollo ==="
          rm -rf ./vendor ./tests ./phpunit.xml ./psalm.xml ./.github
          composer install --no-dev --no-scripts

      - name: Release
        if: ${{ steps.check_release.outputs.released == 'true' }}
        id: semver
        uses: huggingface/semver-release-action@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}

      - name: Release Summary
        if: ${{ steps.check_release.outputs.released == 'true' }}
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Version:** ${{ env.CURRENT_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **New Version:** ${{ env.NEXT_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL:** ${{ steps.semver.outputs.release_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** v${{ env.NEXT_VERSION }}" >> $GITHUB_STEP_SUMMARY
