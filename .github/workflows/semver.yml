name: Tests and Release
on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  tests:
    if: |
      github.event_name == 'push' &&
      !contains(github.event.head_commit.message, '[skip ci]')
    name: Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'

      - name: Configure .env file
        run: |
          cp .env.example .env
          cp .env.testing.example .env.testing
          mkdir -p var/logs
          touch var/logs/app.log

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run tests
        run: composer run-script test

  release:
    needs: tests
    if: ${{ needs.tests.result == 'success' }}
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GIT_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'

      - name: Configure .env file
        run: |
          cp .env.example .env
          mkdir -p var/logs
          touch var/logs/app.log

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Get the next version on dry-run
        id: version
        uses: huggingface/semver-release-action@latest
        with:
          dryRun: true
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}

      - name: Check if there is a new version to release
        id: check_release
        run: |
          CURRENT_VERSION=$(jq -r '.version' composer.json)
          NEXT_VERSION="${{ steps.version.outputs.version }}"

          echo "Versión actual: $CURRENT_VERSION"
          echo "Próxima versión: $NEXT_VERSION"

          if [ -z "$NEXT_VERSION" ] || [ "$NEXT_VERSION" == "null" ]; then
            echo "No hay nueva versión para liberar"
            echo "released=false" >> $GITHUB_OUTPUT
          elif [ "$CURRENT_VERSION" == "$NEXT_VERSION" ]; then
            echo "La versión no ha cambiado"
            echo "released=false" >> $GITHUB_OUTPUT
          else
            echo "Nueva versión detectada: $CURRENT_VERSION → $NEXT_VERSION"
            echo "released=true" >> $GITHUB_OUTPUT
            echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
            echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_ENV
          fi

      - name: Update composer.json with next version
        if: ${{ steps.check_release.outputs.released == 'true' }}
        run: |
          NEXT_VERSION=${{ steps.version.outputs.version }}

          cp composer.json composer.json.backup
          jq --arg new_version "$NEXT_VERSION" '.version = $new_version' composer.json > composer.json.tmp
          mv composer.json.tmp composer.json

          echo "=== Versión actualizada en composer.json ==="
          jq -r '.version' composer.json

          # Reparar permisos en .git si fuera necesario (evita errores de "insufficient permission")
          # Intentamos cambiar propietario al usuario actual; en runners públicos esto funciona con sudo.
          if [ -d ".git" ]; then
            echo "Reparando permisos de .git..."
            sudo chown -R "$(id -u):$(id -g)" .git || true
            chmod -R u+rwX .git/objects || true
          fi

          # Configurar Git
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "GitHub Actions"

          echo "=== Estado de Git antes del commit ==="
          git status

          git add composer.json
          git commit -m "chore: bump version to $NEXT_VERSION [skip ci]" || echo "No hay cambios para commitear"

          # Push usando el token directo (asegúrate de que secrets.GIT_TOKEN exista y tenga scope repo si es PAT)
          git push origin HEAD:main

      - name: Sync develop branch with main
        if: ${{ steps.check_release.outputs.released == 'true' }}
        run: |
          echo "=== Sincronizando rama develop con main ==="

          # Fetch todas las ramas
          git fetch origin

          # Checkout a develop
          git checkout develop
          git pull --rebase origin develop

          # Rebase main sobre develop
          git rebase origin/main

          # Push de los cambios a develop
          git push origin develop

          echo "=== Rama develop actualizada y sincronizada con main ==="

      - name: Format Code
        if: ${{ steps.check_release.outputs.released == 'true' }}
        run: composer run-script format

      - name: Clean Dev Dependencies for Release
        if: ${{ steps.check_release.outputs.released == 'true' }}
        run: |
          echo "=== Limpiando dependencias de desarrollo ==="
          rm -rf ./vendor ./tests ./phpunit.xml ./psalm.xml ./.github
          composer install --no-dev --no-scripts

      - name: Release
        if: ${{ steps.check_release.outputs.released == 'true' }}
        id: semver
        uses: huggingface/semver-release-action@latest
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}